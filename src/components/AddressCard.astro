---
// AddressCard.astro
export interface Props {
  title?: string;
  description?: string;
  addressLine1: string;
  addressLine2?: string;
  city: string;
  province: string;
  postalCode: string;
  country: string;
  latitude?: number;
  longitude?: number;
  markerColor?: string;
  markerLabel?: string;
}

const {
  title = "Location",
  description = "",
  addressLine1,
  addressLine2 = "",
  city,
  province,
  postalCode,
  country,
  latitude,
  longitude,
  markerColor = "#3B82F6", // Blue color
  markerLabel = "Our Office",
} = Astro.props;

const fullAddress = `${addressLine1}${addressLine2 ? ", " + addressLine2 : ""}, ${city}, ${province} ${postalCode}, ${country}`;
const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress)}`;
const mapLat = latitude || (postalCode === "M8V 3Y3" ? 43.6022 : 43.6532);
const mapLng = longitude || (postalCode === "M8V 3Y3" ? -79.505 : -79.3832);

// Generate unique ID for this map instance
const mapId = `map-${Math.random().toString(36).substr(2, 9)}`;
---

<div
  class="slide-in-up grid grid-cols-1 md:grid-cols-2 min-h-96 rounded-xl overflow-hidden shadow-md my-10 max-w-7xl mx-auto"
>
  <div class="flex flex-col justify-center p-6 sm:p-8 lg:p-12">
    <div class="mb-4">
      <span class="text-sm font-semibold tracking-wider opacity-80 uppercase"
        >{title}</span
      >
    </div>
    <h2 class="text-3xl sm:text-4xl lg:text-5xl font-bold leading-tight mb-6">
      Appointment<br />
    </h2>
    <div class="w-20 h-1 bg-yellow-400 mb-6"></div>
    {
      description && (
        <p class="text-lg leading-relaxed mb-8 opacity-90">
          {description}
          <span style="color: #011c4d; font-weight: bold;">
            info@karunalaw.ca
          </span>
        </p>
      )
    }
    <div
      class="flex items-start gap-4 text-blue-700 hover:text-blue-600 font-extrabold transition-colors duration-200"
    >
      <div class="flex-shrink-0 mt-1">
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"
            fill="currentColor"></path>
        </svg>
      </div>
      <div class="flex-1">
        <a
          href={googleMapsUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="no-underline hover:underline text-lg leading-relaxed"
        >
          <div class="mb-1">{addressLine1}</div>
          {addressLine2 && <div class="mb-1">{addressLine2}</div>}
          <div>{city}, {province} {postalCode}, {country}</div>
        </a>
      </div>
    </div>
  </div>

  <div class="relative p-4 bg-slate-50">
    <div id={mapId} class="w-full h-full rounded-lg" style="min-height: 400px;">
    </div>
  </div>
</div>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"
  integrity="sha512-h9FcoyWjHcOcmEVkxOfTLnmZFWIH0iZhZT1H2TbOq55xssQGEJHEaIm+PgoUaZbRvQTNTluNOEfb1ZRy6D3BOw=="
  crossorigin="anonymous"
/>

<!-- Leaflet JS -->
<script
  is:inline
  src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"
  integrity="sha512-puJW3E/qXDqYp9IfhAI54BJEaWIfloJ7JWs7OeD5i6ruC9JZL1gERT1wjtwXFlh7CjE7ZJ+/vcRZRkIYIb6p4g=="
  crossorigin="anonymous"></script>

<script
  define:vars={{ mapId, mapLat, mapLng, markerColor, markerLabel, fullAddress }}
>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize map
    const map = L.map(mapId, {
      center: [mapLat, mapLng],
      zoom: 15,
      scrollWheelZoom: false,
    });

    // Add OpenStreetMap tiles with grayscale
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap contributors",
      maxZoom: 19,
      className: "grayscale-tiles",
    }).addTo(map);

    // Create custom icon with SVG
    const customIcon = L.divIcon({
      className: "custom-marker",
      html: `
        <div style="position: relative; width: 40px; height: 40px;">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="${markerColor}"/>
            <circle cx="12" cy="9" r="2.5" fill="white"/>
          </svg>
        </div>
      `,
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40],
    });

    // Add marker with popup
    const marker = L.marker([mapLat, mapLng], { icon: customIcon }).addTo(map);

    // Create popup with label and address
    marker.bindPopup(`
      <div style="text-align: center; font-family: system-ui, -apple-system, sans-serif;">
        <strong style="font-size: 16px; color: ${markerColor};">${markerLabel}</strong>
        <div style="margin-top: 8px; font-size: 14px; color: #374151;">
          ${fullAddress}
        </div>
      </div>
    `);

    // Open popup by default
    marker.openPopup();

    // Re-enable scroll zoom on click
    map.on("click", function () {
      map.scrollWheelZoom.enable();
    });

    // Disable scroll zoom when mouse leaves
    map.on("mouseout", function () {
      map.scrollWheelZoom.disable();
    });
  });
</script>

<style>
  .custom-marker {
    background: transparent !important;
    border: none !important;
  }

  /* Apply grayscale only to map tiles, not markers */
  .grayscale-tiles {
    filter: grayscale(100%);
  }

  .leaflet-popup-content-wrapper {
    border-radius: 8px;
    padding: 8px;
  }

  .leaflet-popup-tip {
    background: white;
  }
</style>
